name: Pulse Generator Workflow

on:
  workflow_dispatch:
    inputs:
      pulse_angle:
        description: 'Hexagon angle (0, 60, 120, 180, 240, 300)'
        required: true
        default: '0'
        type: choice
        options:
          - '0'
          - '60'
          - '120'
          - '180'
          - '240'
          - '300'
      convergence_target:
        description: 'Convergence target (default 0.87)'
        required: false
        default: '0.87'
      force_save:
        description: 'Force save regardless of convergence'
        required: false
        type: boolean
        default: false

jobs:
  generate-pulse:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml jinja2 markdown

      - name: Generate Pulse
        id: pulse_generation
        env:
          PULSE_ANGLE: ${{ github.event.inputs.pulse_angle || '0' }}
          CONVERGENCE_TARGET: ${{ github.event.inputs.convergence_target || '0.87' }}
          FORCE_SAVE: ${{ github.event.inputs.force_save || 'false' }}
        run: |
          python scripts/pulse_generator.py \
            --angle $PULSE_ANGLE \
            --convergence-target $CONVERGENCE_TARGET \
            --force-save $FORCE_SAVE

      - name: Validate VaultNode Inheritance
        run: python scripts/validate_inheritance.py 2>/dev/null || true

      - name: Generate Dashboard Data
        run: python scripts/generate_dashboard_data.py

      - name: Build Jekyll Site
        uses: actions/jekyll-build-pages@v1
        with:
          source: ./docs
          destination: ./_site

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './_site'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Create Pull Request if Converged
        if: steps.pulse_generation.outputs.converged == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          branch: pulse-${{ steps.pulse_generation.outputs.pulse_id }}
          commit-message: 'Pulse ${{ steps.pulse_generation.outputs.pulse_id }}: Convergence ${{ steps.pulse_generation.outputs.convergence_score }}'
          title: 'Pulse ${{ steps.pulse_generation.outputs.pulse_id }} - Convergence: ${{ steps.pulse_generation.outputs.convergence_score }}'
          body: |
            ## Pulse Generation Summary
            
            - **Pulse ID**: ${{ steps.pulse_generation.outputs.pulse_id }}
            - **Geometry**: ${{ steps.pulse_generation.outputs.geometry }}
            - **Convergence Score**: ${{ steps.pulse_generation.outputs.convergence_score }}
            - **Hexagon Angle**: ${{ steps.pulse_generation.outputs.pulse_angle }}°
            - **Irreducible Truth**: ${{ steps.pulse_generation.outputs.irreducible_truth }}
            - **Generated**: ${{ steps.pulse_generation.outputs.timestamp }}
            
            This pulse achieved convergence threshold (≥0.87).
            
            See [Pulse Dashboard](https://acethedactyl.github.io/Perplexity-Saves/) for details.
          labels: 'pulse-generated,convergence-achieved'
          reviewers: 'AceTheDactyl'
